<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: image_check.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: image_check.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
* @file intercepts post submits and makes a verification on the image valididty
* @author Alexandre Falardeau
*
* the testImage function comes from this source
* https://stackoverflow.com/questions/9714525/javascript-image-url-verify
*
* @todo: find if this can be done in the back end
*/


/**
* @function checks if an given path will load an image
* @async
*
* Races the url image load against a timer to check if the image can be loaded.
* The function does this by creating an Image object an success/error handlers
*
*@param {string} url
* the given url that will be checked
*
*@return a promise that resolves to the value of a successful url
*/
function testImage(url) {

    var timedOut = false;
    var img = new Image();

    return new Promise(function(fulfill, reject) {

      img.onerror = img.onabort = () => {
          if (!timedOut) {
            console.log("load failed");
              clearTimeout(timer);
              reject("load failed");
          }
      };

      img.onload = function() {
          if (!timedOut) {
            console.log("loaded");
              clearTimeout(timer);
              fulfill(url);
          }
      };

      img.src = url;

      timer = setTimeout(function() {
          console.log("timedout");
          timedOut = true;
          // reset .src to invalid URL so it stops previous
          // loading, but doesn't trigger new load
          img.src = "//!!!!/test.jpg";
          reject("timeout");
      }, 5000);

    })
}

/**
* @function ensures that a valid image url is sent back to the router
* @async
*
* This function will first check if the string value is null. In the case that
* it is, it will fulfill the image with the default image url. Else, it uses
* the testImage function to make sure the url is valid, and either fulfills
* the promise with the user given or default image url.
*
*@param {string} image
* the value of the html image url input that will be checked
*
*@return a promise that resolves to the value of the url that will be used
*/
function fillImage(image) {
  console.log("fillImage is being invoked")
  return new Promise(function(fulfill, reject) {
    if (!image){
      image = "/images/brain.jpg";
      console.log("image has been filled")
      // Need to find default image
      fulfill(image);
    }
    else {

      let test = testImage(image);
      test.then( url => {
        console.log("success");
        fulfill(url);
      },
      err => {
        console.log("failure, because of:" + err);
        // image = "/images/brain.jpg";
        fulfill("/images/brain.jpg");
      });
    }
  })
}

/** @global */
let imageHasBeenChecked = false;

/**
* @event
* Intercepts the form submits and checks the validity of the image's url
*/

$("form").submit(function(e){
  if (!imageHasBeenChecked) {
    e.preventDefault();

    let imageInputElement = $('input[name="image"]')[0];
    let userProvidedImage = imageInputElement.value;

    fillImage(userProvidedImage)
    .then((returnedImage)=> {

      // let postInformation = extractFormInformation();
      console.log("Image filled in by check: " + returnedImage);
      imageInputElement.value = returnedImage;

      console.log("Ajax request is about to be sent");
      imageHasBeenChecked = true;
      $(this).submit();
    },
    err=> {
      console.log(err);
    });
  }
});
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Events</h3><ul><li><a href="global.html#event:Interceptstheformsubmitsandchecksthevalidityoftheimage'surl">Intercepts the form submits and checks the validity of the image's url</a></li></ul><h3>Global</h3><ul><li><a href="global.html#checksifangivenpathwillloadanimage">checks if an given path will load an image</a></li><li><a href="global.html#ensuresthatavalidimageurlissentbacktotherouter">ensures that a valid image url is sent back to the router</a></li><li><a href="global.html#imageHasBeenChecked">imageHasBeenChecked</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Sep 11 2018 16:43:06 GMT-0400 (EDT)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
